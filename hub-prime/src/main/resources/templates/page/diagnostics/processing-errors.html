<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org" xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
    layout:decorate="~{layout/prime}">

<head> 
    <style>
        .grid-description{
            font-size: 14px;
            margin: 5px 0px 5px 15px;
        }
    </style>
    <!-- if JSON Viewer is not already in the layout, add the following -->
    <!-- <script src="https://unpkg.com/@alenaksu/json-viewer@2.0.0/dist/json-viewer.bundle.js"></script> -->

    <th:block th:insert="./fragments/common-head-aggrid :: common-head-aggrid"></th:block>
    <script type="module">
        import { AGGridAide, AGGridAideBuilder } from '@presentation/shell/aggrid-aide.js';
        import ModalAide from '@presentation/shell/modal-aide.js';

        const schemaName = 'techbd_udi_ingress';
        const viewName = 'csv_processing_errors_summary';
        const detailViewName = 'csv_processing_error';

        function getDetailData(params) { 
            const zip_file_hub_interaction_id = params.data.zip_file_hub_interaction_id;
             
            fetch(window.shell.serverSideUrl(`/api/ux/tabular/jooq/${schemaName}/${detailViewName}/zip_file_hub_interaction_id/${zip_file_hub_interaction_id}.json`))
                .then(response => {
                    if (response.url.includes('/?timeout=true')) {
                        window.location.href = '/?timeout=true'; // Redirect to login page
                        return null; // Prevent further processing of the response
                    }
                    return response.json();
                })
                .then(response => {
                    params.successCallback(response);
                })
                .catch(error => {
                    console.error('Error fetching details data' + error);
                });
        }

        document.addEventListener('DOMContentLoaded', function () {

        const detailGrid = [
                            { 
                                headerName: "Error Message", 
                                field: "error", 
                                filter: "agTextColumnFilter", 
                                headerTooltip: "The detailed error message describing the validation issue.",
                                tooltipField: "error" 
                            },
                            { 
                                headerName: "Description", 
                                field: "description", 
                                filter: "agTextColumnFilter", 
                                headerTooltip: "A brief description of the validation error.",
                                tooltipField: "description" 
                            },
                            { 
                                headerName: "File Name", 
                                field: "file_name", 
                                filter: "agTextColumnFilter", 
                                headerTooltip: "The name of the CSV file where the error occurred."
                            }
        ];

            const modalAide = new ModalAide();
            const agGridInstance = new AGGridAideBuilder()
            .withColumnDefs([
                            { 
                                headerName: "Created Time", 
                                field: "created_at", 
                                sortable: true, 
                                sort: "desc", 
                                filter: "agDateColumnFilter", 
                                headerTooltip: "The timestamp when the CSV validation error was recorded."
                            },
                            { 
                                headerName: "TechBD Tenant ID", 
                                field: "tenant_id", 
                                filter: "agTextColumnFilter", 
                                headerTooltip: "The unique identifier for the TechBD tenant associated with the CSV file.",                               
                            },    
                            { 
                                headerName: "TechBD Zip File Interaction ID", 
                                field: "zip_file_hub_interaction_id", 
                                filter: "agTextColumnFilter", 
                                headerTooltip: "The unique zip file Interaction ID for the TechBD tenant associated with the CSV file.",
                                cellRenderer: 'agGroupCellRenderer'                                
                            },                         
                            { 
                                headerName: "URI", 
                                field: "uri", 
                                filter: "agTextColumnFilter", 
                                headerTooltip: "The URI where the CSV file was submitted or validated."
                            },                        
                            { 
                                headerName: "Zip File Name", 
                                field: "zip_file_name", 
                                filter: "agTextColumnFilter", 
                                headerTooltip: "The name of the ZIP file where the error occurred."
                            },
                            { 
                                headerName: "Error Type", 
                                field: "error_types", 
                                filter: "agTextColumnFilter", 
                                headerTooltip: "The category or type of validation error encountered."
                            },                                                                                      
                            { 
                                headerName: "Origin", 
                                field: "origin", 
                                filter: "agTextColumnFilter", 
                                headerTooltip: "The origin of the CSV file."
                            }, 
                            { 
                                headerName: "User Agent", 
                                field: "user_agent", 
                                filter: "agTextColumnFilter", 
                                headerTooltip: "The User Agent of the user who submitted the CSV file."
                            }                            
                        ])
                .withServerSideDatasource(
                    window.shell.serverSideUrl(`/api/ux/tabular/jooq/${schemaName}/${viewName}.json`),
                    (data, valueCols) => {
                        return valueCols.map(col => ({
                            headerName: col.displayName,
                            field: col.field
                        }));
                    },
                )
                .withMasterDetail(true)
                .withDetailCellRendererParams({
                    detailGridOptions: {
                        columnDefs: detailGrid,
                        defaultColDef: {
                            flex: 1
                        }
                    },
                    getDetailRowData: params => {
                        getDetailData(params);
                    }
                })
                .withDetailRowAutoHeight(false)
                .withModalAide(modalAide)
                .withGridDivStyles({ height: "750px", width: "100%" })
                .build();

            agGridInstance.init('serverDataGrid');
        });
    </script>
</head>

<body>
    <div layout:fragment="content">
        <div class="grid-description">
            This data grid displays diagnostic and exception details captured during data ingestion and interaction processing. It includes information about processing errors, missing or invalid files, encoding issues, and file naming violations. The grid helps identify records that failed validation or were not processed successfully, enabling users to quickly pinpoint the root cause of ingestion failures. A drill-down view provides deeper insights into each exception, including detailed error messages and contextual information for efficient troubleshooting and data quality improvement.
         </div>
        <div id="serverDataGrid" class="ag-theme-alpine"></div>
    </div>
</body>

</html>