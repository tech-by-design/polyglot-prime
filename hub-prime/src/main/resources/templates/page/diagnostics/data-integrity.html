<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org" xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
    layout:decorate="~{layout/prime}">

<head>
  
    <style>
        .grid-description{
            font-size: 14px;
            margin: 5px 0px 5px 15px;
        }
    </style>
    <!-- if JSON Viewer is not already in the layout, add the following -->
    <!-- <script src="https://unpkg.com/@alenaksu/json-viewer@2.0.0/dist/json-viewer.bundle.js"></script> -->

    <th:block th:insert="./fragments/common-head-aggrid :: common-head-aggrid"></th:block>
    <script type="module">
        import { AGGridAide, AGGridAideBuilder } from '@presentation/shell/aggrid-aide.js';
        import ModalAide from '@presentation/shell/modal-aide.js';
        import { Helpers } from '@presentation/shell/helpers.js';

        const schemaName = 'techbd_udi_ingress';
        const viewName = 'csv_data_integrity_error_summary';
        const detailStoredProc = 'get_csv_data_integrity_error_details';
        const csvErrorsStoredProc = 'get_csv_data_integrity_errors';
        // Define column definitions for the detailed error grid
        const detailColumnDefs = [
            {
                headerName: "TechBD Group Interaction ID",
                field: "hub_interaction_id",
                filter: "agTextColumnFilter",
                headerTooltip: "The unique Group Interaction ID for the TechBD tenant associated with the CSV file."
            }, 
            {
                headerName: "Field Name",
                field: "fieldname",
                filter: "agTextColumnFilter",
                headerTooltip: "The name of the field in the CSV file where the error occurred."
            },
            {
                headerName: "Cell Value",
                field: "value",
                filter: "agTextColumnFilter",
                headerTooltip: "The value of the cell in the CSV file that triggered the error."
            },
            {
                headerName: "Error Type",
                field: "error_type",
                filter: "agTextColumnFilter",
                headerTooltip: "The category or type of validation error encountered."
            },
            {
                headerName: "File Name",
                field: "file_name",
                filter: "agTextColumnFilter",
                headerTooltip: "The name of the CSV file where the error occurred."
            },
            {
                headerName: "Error Message",
                field: "error",
                filter: "agTextColumnFilter",
                headerTooltip: "The detailed error message describing the validation issue.",
                tooltipField: "error"    
            },
            {
                headerName: "Description",
                field: "description",
                filter: "agTextColumnFilter",
                headerTooltip: "A brief description of the validation error.",
                tooltipField: "description"  
            },
            {
                headerName: "Row Number",
                field: "rownumber",
                filter: "agNumberColumnFilter",
                headerTooltip: "The row number in the CSV file where the error occurred."
            },
            {
                headerName: "Field Number",
                field: "fieldnumber",
                filter: "agNumberColumnFilter",
                headerTooltip: "The field number in the CSV file where the error occurred."
            }
        ];

        // Function to get CSV data integrity error details for drill-down
        function getCsvDataIntegrityErrorDetails(params) {
            const zip_file_hub_interaction_id = params.data.zip_file_hub_interaction_id;

            console.log('Drill-down called for zip_file_hub_interaction_id:', zip_file_hub_interaction_id);

            // Use stored procedure with filtering parameters
            const storedProcParams = {
                "p_zip_file_hub_interaction_id": zip_file_hub_interaction_id
            };

            const gridRequestBody = {
                "startRow": 0,
                "endRow": 1000, // show all data without limit
                "rowGroupCols": [],
                "valueCols": [],
                "pivotCols": [],
                "pivotMode": false,
                "groupKeys": [],
                "filterModel": {},
                "sortModel": []
            };

            const paramsJson = encodeURIComponent(JSON.stringify(storedProcParams));
            const url = window.shell.serverSideUrl(`/api/ux/tabular/jooq/sp/${schemaName}/${csvErrorsStoredProc}.json?storedProcparams=${paramsJson}`);

            console.log('Calling URL:', url);
            console.log('Stored proc params:', storedProcParams);

            fetch(url, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify(gridRequestBody)
            })
                .then(response => {
                    console.log('Response status:', response.status);
                    if (response.url.includes('/?timeout=true')) {
                        window.location.href = '/?timeout=true'; // Redirect to login page
                        return null; // Prevent further processing of the response
                    }
                    if (!response.ok) {
                        throw new Error(`HTTP error! status: ${response.status}`);
                    }
                    return response.json();
                })
                .then(response => {
                    console.log('Raw response:', response);
                    let rowData = response;

                    if (!Array.isArray(rowData)) {
                        if (rowData && rowData.rows && Array.isArray(rowData.rows)) {
                            console.log('Using response.rows, length:', rowData.rows.length);
                            rowData = rowData.rows;
                        } else if(rowData && rowData.data && Array.isArray(rowData.data)){
                            console.log('Using response.data, length:', rowData.data.length);
                            rowData = rowData.data;
                        } else {
                            console.error("Unexpected response format:", response);
                            console.log('Response keys:', Object.keys(response || {}));
                            rowData = [];
                        }
                    } else {
                        console.log('Direct array response, length:', rowData.length);
                    }

                    console.log('Final rowData:', rowData);
                    params.successCallback(rowData, rowData.length);
                })
                .catch(error => {
                    console.error('Error fetching CSV data integrity error details: ' + error);
                    params.failCallback();
                });
        }

        document.addEventListener('DOMContentLoaded', function () {
            const modalAide = new ModalAide();
            const helpers = new Helpers();
            const agGridInstance = new AGGridAideBuilder()
            .withColumnDefs([
                            { 
                                headerName: "Created Time", 
                                field: "created_at", 
                                sortable: true, 
                                sort: "desc", 
                                filter: "agDateColumnFilter", 
                                headerTooltip: "The timestamp when the CSV validation error was recorded."
                            },
                            { 
                                headerName: "TechBD Tenant ID", 
                                field: "tenant_id", 
                                filter: "agTextColumnFilter", 
                                headerTooltip: "The unique identifier for the TechBD tenant associated with the CSV file."
                            },
                            {
                                headerName: "TechBD Zip File Interaction ID",
                                field: "zip_file_hub_interaction_id",
                                filter: "agTextColumnFilter",
                                cellRenderer: 'agGroupCellRenderer',
                                headerTooltip: "The unique zip file Interaction ID for the TechBD tenant associated with the CSV file."                                
                            },
                            { 
                                headerName: "URI", 
                                field: "uri", 
                                filter: "agTextColumnFilter", 
                                headerTooltip: "The URI where the CSV file was submitted or validated."
                            },
                            { 
                                headerName: "File Name", 
                                field: "csv_zip_file_name", 
                                filter: "agTextColumnFilter", 
                                headerTooltip: "The name of the CSV file where the error occurred."
                            },
                             { 
                                headerName: "User Agent", 
                                field: "user_agent", 
                                filter: "agTextColumnFilter", 
                                headerTooltip: "The User Agent of the user who submitted the CSV file."
                            } 
                        ])
                .withServerSideDatasource(
                    window.shell.serverSideUrl(`/api/ux/tabular/jooq/${schemaName}/${viewName}.json`),
                    (data, valueCols) => {
                        return valueCols.map(col => ({
                            headerName: col.displayName,
                            field: col.field
                        }));
                    },
                )
                .withMasterDetail(true)
                .withDetailCellRendererParams({
                    detailGridOptions: {
                        columnDefs: detailColumnDefs,
                        defaultColDef: {
                            flex: 1
                        }
                    },
                    getDetailRowData: params => {
                        getCsvDataIntegrityErrorDetails(params);
                    }
                })
                .withDetailRowAutoHeight(false)
                .withModalAide(modalAide)
                .withGridDivStyles({ height: "750px", width: "100%" })
                .build();

            agGridInstance.init('serverDataGrid');
        });
    </script>
</head>

<body>
    <div layout:fragment="content">
        <div class="grid-description">
            This data grid provides a comprehensive overview of CSV data integrity errors within submitted files, displaying critical information such as Created Time, Tenant ID, Interaction ID, URI, File Name, and User Agent.
            A drill-down feature enables users to explore detailed insights for each entry by clicking the expand arrow next to any row. This reveals specific field-level validation errors, including Field Name, Cell Value, Error Type, Error Message, Row Number, and Field Number, providing comprehensive context for efficient error tracing and resolution.
             The grid highlights data validation issues including foreign key violations, incorrect values, and constraint errors, enabling users to quickly identify and address data quality problems.
        </div>
        <div id="serverDataGrid" class="ag-theme-alpine"></div>
    </div>
</body>

</html>