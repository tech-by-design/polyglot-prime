<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org" xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
    layout:decorate="~{layout/prime}">

<head>
    <!-- Include Font Awesome in your HTML -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <th:block th:insert="./fragments/common-head-aggrid :: common-head-aggrid"></th:block>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>

    <style>
        .grid-description {
            font-size: 14px;
            margin: 8px 0px 10px 15px;
        }

        .ag-cell.capitalize-first-letter::first-letter {
            text-transform: uppercase;
        }
    </style>
    <script type="module">
        import { AGGridAide, AGGridAideBuilder } from '@presentation/shell/aggrid-aide.js';
        import ModalAide from '@presentation/shell/modal-aide.js';

        const schemaName = 'techbd_udi_ingress';
        const viewName = 'interaction_csv_http';
        const viewdetail = 'interaction_csv_http_fhir_request';
        const pipupviewName = 'interaction_http_fhir_request';
        const downloadviewName = 'interaction_csv_http_stat_file_data';
        const modalAide = new ModalAide();
        const fhirColumnDefs = [
            {
                headerName: "TechBD Interaction ID", field: "interaction_id", filter: "agTextColumnFilter",
                cellRenderer: AGGridAide.modalCellRenderer((params, modalAide) => {
                    modalAide.viewFetchedJsonValue(window.shell.serverSideUrl(`/api/ux/tabular/jooq/${schemaName}/${pipupviewName}/sat_interaction_http_request_id/${params.data.sat_interaction_http_request_id}.json`));
                }, modalAide)
            },
            { headerName: "Bundle ID", field: "bundle_id", filter: "agTextColumnFilter" },
            { headerName: "Bundle Resource Type", field: "bundle_resource_type", filter: "agTextColumnFilter" },
            { 
                headerName: "Operation Outcome Status", 
                field: "is_bundle_valid", 
                filter: "agTextColumnFilter", 
                headerTooltip: "Indicates whether the OperationOutcome is valid ('Valid' or 'Invalid')" 
            }, 
            { headerName: "Source MRN", field: "source_mrn", filter: "agTextColumnFilter" },
            { headerName: "Patient MRN", field: "patient_mrn", filter: "agTextColumnFilter" },
            { headerName: "MRN Source", field: "patient_mrn_source_system", filter: "agTextColumnFilter", headerTooltip: "Source of the patient MRN" },
            { headerName: "URI", field: "uri", filter: "agTextColumnFilter", headerTooltip: "The URI associated with the interaction" },
            { headerName: "Nature", field: "nature", filter: "agTextColumnFilter" },
            { headerName: "From State", field: "from_state", filter: "agTextColumnFilter", headerTooltip: "The state transition details of the interaction" },
            { headerName: "To State", field: "to_state", filter: "agTextColumnFilter", headerTooltip: "The state transition details of the interaction" }, 
            { headerName: "FHIR Resources", field: "resource_types", filter: "agTextColumnFilter", headerTooltip: "Types of FHIR resources involved in the interaction" },
        ];
        function getFhirGridData(params) {
            const hub_interaction_id = params.data.hub_interaction_id;
            fetch(window.shell.serverSideUrl(`/api/ux/tabular/jooq/${schemaName}/${viewdetail}/source_hub_interaction_id/${hub_interaction_id}.json`))
                .then(response => {
                    if (response.url.includes('/?timeout=true')) {
                        window.location.href = '/?timeout=true'; // Redirect to login page
                        return null; // Prevent further processing of the response
                    }
                    return response.json();
                })
                .then(response => {
                    params.successCallback(response);
                })
                .catch(error => {
                    console.error('Error fetching details data' + error);
                });
        }

        document.addEventListener('DOMContentLoaded', function () {

            function downloadCellRenderer(params) {
                const hub_interaction_id = params.data.hub_interaction_id;
                const csv_zip_file_name = params.data.csv_zip_file_name || '';

                const apiUrl = `/api/ux/tabular/jooq/download/${schemaName}/sat_interaction_zip_file_request/csv_zip_file_content/hub_interaction_id/${hub_interaction_id}?fileName=${csv_zip_file_name}`;

                // Create a download link placeholder
                return `<a href="${apiUrl}" title="${csv_zip_file_name}"  return false;" style="text-decoration: none; color: #007bff;">
                    <i class="fas fa-download"></i>
                </a>`;
            }

            function downloadValidationResultCellRenderer(params) {
                const hub_interaction_id = params.data.hub_interaction_id;
                const validation_result = params.data.selected_field || 'validation_result_payload';
                const file_name = `${params.data.csv_zip_file_name}_validation_result.json`;

                const apiUrl = `/api/ux/tabular/jooq/download/${schemaName}/sat_interaction_zip_file_request/${validation_result}/hub_interaction_id/${hub_interaction_id}?fileName=${file_name}`;

                // Create a download link placeholder
                return `<a href="${apiUrl}" title="${file_name}"  return false;" style="text-decoration: none; color: #007bff;">
                    <i class="fas fa-download"></i>
                </a>`;
            }

            function formatStatus(text) {
                return text
                    .toLowerCase()
                    .split('_')
                    .map(word => word.charAt(0).toUpperCase() + word.slice(1))
                    .join(' ');
            }

            const agGridInstance = new AGGridAideBuilder()
                .withColumnDefs([
                    {
                        headerName: "Request Time",
                        field: "created_at",
                        filter: "agDateColumnFilter",
                        headerTooltip: "The timestamp indicating when the interaction was initiated."
                    },
                    {
                        headerName: "TechBD Zip File Interaction ID",
                        field: "hub_interaction_id",
                        filter: "agTextColumnFilter",
                        headerTooltip: "The unique zip file Interaction ID for the TechBD tenant associated with the CSV file."
                    },
                    { headerName: "TechBD Tenant ID", field: "tenant_id", headerTooltip: "ID of the tenant involved in the interaction", filter: "agTextColumnFilter" },
                    { headerName: "URI", field: "uri", headerTooltip: "The URI associated with the interaction", filter: "agTextColumnFilter" },
                    { headerName: "Processing Status", field: "status", headerTooltip: "The ZIP file processing status.", filter: "agTextColumnFilter" },
                    {
                        headerName: "CSV Validation Status",
                        field: "data_validation_status",
                        headerTooltip: "The status of CSV file validation for the zip file.",
                        filter: "agTextColumnFilter",
                        cellRenderer: params => {
                            if (params.value === 'Failed' || params.value === 'Partial Success') {
                                return `<a href="/data-quality/csv-validations/file-not-processed" target="_blank" class="text-blue-600 underline hover:text-blue-800 font-medium">${params.value}</a>`;
                            } else {
                                return params.value;
                            }
                        }
                    },
                    { headerName: "Total File Count", field: "total_number_of_files_in_zip_file", headerTooltip: "The total number of files received within the ZIP.", filter: "agNumberColumnFilter" },
                    { headerName: "FHIR Count", field: "number_of_fhir_bundles_generated_from_zip_file", headerTooltip: "The total number of FHIR bundles generated from the ZIP file.", filter: "agNumberColumnFilter",    cellRendererSelector: params => {
                        if  (params.data.uri &&
                            (params.data.uri === '/flatfile/csv/Bundle/$validate' ||
                            params.data.uri === '/flatfile/csv/Bundle/$validate/')) {
                            return {
                                component: undefined // shows blank cell, no drill-down
                            };
                        }
                        return {
                            component: 'agGroupCellRenderer'
                        };
                    },    valueGetter: params => {
                        if  ( params.data.uri &&
                            (params.data.uri === '/flatfile/csv/Bundle/$validate' ||
                            params.data.uri === '/flatfile/csv/Bundle/$validate/')) {
                            return null; // return null so nothing is shown
                        }
                        return params.data.number_of_fhir_bundles_generated_from_zip_file;
                    }  },
                    { headerName: "FHIR Success Count", field: "fhir_count_success", headerTooltip: "The number of successful FHIR interactions where an HTTP response was forwarded.", filter: "agNumberColumnFilter",cellRenderer: params => {
                        return params.data && (params.data.uri === '/flatfile/csv/Bundle/$validate' || params.data.uri === '/flatfile/csv/Bundle/$validate/')
                            ? ''
                            : params.value;
                    } },
                    { headerName: "FHIR Failed Count", field: "fhir_count_failed", headerTooltip: "The number of failed FHIR interactions where an HTTP response error was forwarded.", filter: "agNumberColumnFilter",cellRenderer: params => {
                        return params.data && (params.data.uri === '/flatfile/csv/Bundle/$validate' || params.data.uri === '/flatfile/csv/Bundle/$validate/')
                            ? ''
                            : params.value;
                    } },
                    {
                        headerName: "Zip File", field: "download", cellClass: "flex justify-center items-center", cellRenderer: downloadCellRenderer,
                        headerTooltip: "Download Zip File", filter: false, suppressFilter: true
                    },
                    {
                        headerName: "OperationOutcome",
                        field: "validation_result_file_name",
                        cellClass: "flex justify-center items-center",
                        cellRenderer: downloadValidationResultCellRenderer,
                        headerTooltip: "Download OperationOutcome",
                        filter: false,
                        suppressFilter: true
                    }
                ])
                .withServerSideDatasource(
                    window.shell.serverSideUrl(`/api/ux/tabular/jooq/${schemaName}/${viewName}.json`),
                    (data, valueCols) => {
                        return valueCols.map(col => ({
                            headerName: col.displayName,
                            field: col.field
                        }));
                    },
                )
                .withMasterDetail(true)
                .withDetailCellRendererParams({
                    detailGridOptions: {
                        columnDefs: fhirColumnDefs,
                        defaultColDef: {
                            flex: 1
                        }
                    },
                    getDetailRowData: params => {
                        getFhirGridData(params);
                    }
                })
                .withDetailRowAutoHeight(false)
                .withModalAide(modalAide)
                .withGridDivStyles({ height: "750px", width: "100%" })
                .build();

            agGridInstance.init('serverDataGrid');
        });
    </script>
</head>

<body>
    <div layout:fragment="content">
        <div class="grid-description">
            <div class=" text-base leading-relaxed text-sm">

                <p class="mb-1">
                    This widget presents a detailed view of CSV-based HTTP interactions processed through the system.
                    Each row represents a single interaction initiated via a ZIP file, with essential metadata and
                    outcomes displayed in an accessible format. 
                </p>

                <button id="accordionToggle"
                    class="mb-2 text-blue-700 font-semibold hover:underline focus:outline-none">
                    ▶ Click here to view the column descriptions:
                </button>
                 <div id="accordionContent" class="hidden pl-4 border-l-2 border-blue-200"> 
                <!--<div id="accordionContent"  > -->
                    <p class="mb-2" >
                        <strong>Request Time:</strong> Shows when the interaction was initiated.<br>
                        <strong>TechBD Zip File Interaction ID:</strong> Serves as the unique reference for the
                        submitted ZIP file. Users can use this ID to trace issues and cross-reference CSV validation
                        results.<br>
                        <strong>TechBD Tenant ID:</strong> Identifies the tenant associated with the request.<br>
                        <strong>URI:</strong> Displays the endpoint involved in the interaction.<br>
                        <strong>Processing Status:</strong> Indicates the current state of ZIP file processing (e.g.,
                        <em>Processing Inprogress</em>, <em>Processing Completed</em>, <em>Processing Failed</em>  <!-- <em>Received</em>--> etc.), helping
                        users understand where the file stands in the processing pipeline.<br>
                        <strong>CSV Validation Status:</strong> Highlights whether the FHIR conversion from the submitted CSV
                        failed. If a Failure/Partial Success occurred, a direct link is provided to the
                        <a href="/data-quality/csv-validations/file-not-processed" class="text-blue-600 underline"
                            target="_blank">CSV Data Quality page</a> for detailed error insights. You can use the
                        Interaction ID to filter errors on that page.<br>                                            
                        <strong>Total File Count:</strong> Shows the total number of files received within the ZIP file.<br>
                        <strong>FHIR Count:</strong> Reflects the total FHIR interactions triggered by the request, and
                        can be expanded for detailed interaction-level insight.<br>
                        <strong>FHIR Success Count:</strong> Indicates how many of those interactions were successfully
                        forwarded as valid FHIR resources to DataLake.<br>
                        <strong>FHIR Failed Count:</strong> Indicates how many of those interactions failed to be forwarded
                         as valid FHIR resources to DataLake.<br>
                        <strong>Download Options:</strong> Users can download the original ZIP file submitted for
                        processing and the corresponding OperationOutcome file, which contains validation results for
                        debugging and analysis.
                    </p>
                </div>

                <p>
                    Sorting and filtering options are available throughout the grid to help users efficiently explore,
                    analyze, and identify issues in the interactions.
                </p>

            </div>

            <script>
                const toggleButton = document.getElementById('accordionToggle');
                const content = document.getElementById('accordionContent');

                toggleButton.addEventListener('click', () => {
                    content.classList.toggle('hidden');
                    toggleButton.textContent = content.classList.contains('hidden')
                        ? '▶ Click here to view the column descriptions:'
                        : '▼ Hide column descriptions:';
                });
            </script>


        </div>
        <div id="serverDataGrid" class="ag-theme-alpine"></div>
    </div>
</body>

</html>