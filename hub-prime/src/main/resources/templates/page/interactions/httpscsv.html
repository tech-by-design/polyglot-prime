<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org" xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
    layout:decorate="~{layout/prime}">

<head>
    <!-- Include Font Awesome in your HTML -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <th:block th:insert="./fragments/common-head-aggrid :: common-head-aggrid"></th:block>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>

    <style>
        .grid-description {
            font-size: 14px;
            margin: 8px 0px 10px 15px;
        }

        .ag-cell.capitalize-first-letter::first-letter {
            text-transform: uppercase;
        }
    </style>
    <script type="module">
        import { AGGridAide, AGGridAideBuilder } from '@presentation/shell/aggrid-aide.js';
        import ModalAide from '@presentation/shell/modal-aide.js';

        const schemaName = 'techbd_udi_ingress';
        const viewName = 'interaction_csv_http';
        const viewdetail = 'interaction_csv_http_fhir_request';
        const pipupviewName = 'interaction_http_fhir_request';
        const downloadviewName = 'interaction_csv_http_stat_file_data';
        const modalAide = new ModalAide();
        const fhirColumnDefs = [
            {
                headerName: "TechBD Interaction ID", field: "interaction_id", filter: "agTextColumnFilter",
                cellRenderer: AGGridAide.modalCellRenderer((params, modalAide) => {
                    modalAide.viewFetchedJsonValue(window.shell.serverSideUrl(`/api/ux/tabular/jooq/${schemaName}/${pipupviewName}/sat_interaction_http_request_id/${params.data.sat_interaction_http_request_id}.json`));
                }, modalAide)
            },
            { headerName: "Bundle ID", field: "bundle_id", filter: "agTextColumnFilter" },
            { headerName: "Bundle Resource Type", field: "bundle_resource_type", filter: "agTextColumnFilter" },
            { headerName: "Source MRN", field: "source_mrn", filter: "agTextColumnFilter" },
            { headerName: "Patient MRN", field: "patient_mrn", filter: "agTextColumnFilter" },
            { headerName: "MRN Source", field: "patient_mrn_source_system", filter: "agTextColumnFilter", headerTooltip: "Source of the patient MRN" },
            { headerName: "URI", field: "uri", filter: "agTextColumnFilter", headerTooltip: "The URI associated with the interaction" },
            { headerName: "Nature", field: "nature", filter: "agTextColumnFilter" },
            { headerName: "From State", field: "from_state", filter: "agTextColumnFilter", headerTooltip: "The state transition details of the interaction" },
            { headerName: "To State", field: "to_state", filter: "agTextColumnFilter", headerTooltip: "The state transition details of the interaction" },
            { headerName: "Validation Issues", field: "issues_count", filter: "agTextColumnFilter", headerTooltip: "Count of issues encountered during validation" },
            { headerName: "FHIR Resources", field: "resource_types", filter: "agTextColumnFilter", headerTooltip: "Types of FHIR resources involved in the interaction" },
            { headerName: "IP Address", field: "client_ip_address", filter: "agTextColumnFilter", headerTooltip: "IP address of the client making the request" },
            { headerName: "User Agent", field: "user_agent", filter: "agTextColumnFilter", headerTooltip: "User agent (browser or system) used in the request" },
        ];
        function getFhirGridData(params) {
            const hub_interaction_id = params.data.hub_interaction_id;
            fetch(window.shell.serverSideUrl(`/api/ux/tabular/jooq/${schemaName}/${viewdetail}/source_hub_interaction_id/${hub_interaction_id}.json`))
                .then(response => {
                    if (response.url.includes('/?timeout=true')) {
                        window.location.href = '/?timeout=true'; // Redirect to login page
                        return null; // Prevent further processing of the response
                    }
                    return response.json();
                })
                .then(response => {
                    params.successCallback(response);
                })
                .catch(error => {
                    console.error('Error fetching details data' + error);
                });
        }

        // Define downloadValidationResult globally
        window.downloadValidationResult = async function (apiUrl, file_name = 'validation_result.json') {
            try {
                // Fetch data from the API
                const response = await fetch(apiUrl);
                if (!response.ok) {
                    throw new Error('Network response was not ok');
                }

                // Get the JSON data
                const data = await response.json();

                // Extract only the payload from the response
                const payload = data[0]?.validation_result_payload;

                // Convert the payload to a JSON string
                const jsonString = JSON.stringify(payload, null, 2);

                // Create a Blob from the JSON string
                const blob = new Blob([jsonString], { type: "application/json" });

                // Create a URL for the Blob
                const url = URL.createObjectURL(blob);

                // Create a temporary link to trigger the download
                const tempLink = document.createElement('a');
                tempLink.href = url;
                tempLink.download = file_name + '.json';
                document.body.appendChild(tempLink);
                tempLink.click();

                // Clean up
                document.body.removeChild(tempLink);
                URL.revokeObjectURL(url);

            } catch (error) {
                console.error('Error downloading payload:', error);
            }
        };


        document.addEventListener('DOMContentLoaded', function () {

            function downloadCellRenderer(params) {
                const hub_interaction_id = params.data.hub_interaction_id;
                const csv_zip_file_name = params.data.csv_zip_file_name || '';

                // // Create the URL for the API call
                // const apiUrl = `/api/ux/tabular/jooq/${schemaName}/interaction_csv_zip_download/hub_interaction_id/${hub_interaction_id}.json`;
 
                // // Create a download link placeholder
                // return `<a href="#" title="${csv_zip_file_name}" onclick="window.downloadZipFile('${apiUrl}','${csv_zip_file_name}'); return false;" style="text-decoration: none; color: #007bff;">
                //     <i class="fas fa-download"></i>
                // </a>`;

                const apiUrl = `/api/ux/tabular/jooq/binarydownload/${schemaName}/sat_interaction_zip_file_request/csv_zip_file_content/csv_zip_file_name/hub_interaction_id/${hub_interaction_id}`;

                // Create a download link placeholder
                return `<a href="${apiUrl}" title="${csv_zip_file_name}"  return false;" style="text-decoration: none; color: #007bff;">
                    <i class="fas fa-download"></i>
                </a>`;
            }

            function downloadValidationResultCellRenderer(params) {
                const hub_interaction_id = params.data.hub_interaction_id;
                const file_name = `${params.data.csv_zip_file_name}_validation_result.json`;
                const apiUrl = `/api/ux/tabular/jooq/${schemaName}/interaction_csv_http_validation_result/hub_interaction_id/${hub_interaction_id}.json`;

                return `<a href="#" title="${file_name}" onclick="window.downloadValidationResult('${apiUrl}','${file_name}'); return false;" style="text-decoration: none; color: #007bff;">
                                        <i class="fas fa-download"></i>
                                    </a>`;

            }

            function formatStatus(text) {
                return text
                    .toLowerCase()
                    .split('_')
                    .map(word => word.charAt(0).toUpperCase() + word.slice(1))
                    .join(' ');
            }

            const agGridInstance = new AGGridAideBuilder()
                .withColumnDefs([
                    {
                        headerName: "Request Time",
                        field: "created_at",
                        filter: "agDateColumnFilter",
                        headerTooltip: "The timestamp indicating when the interaction was initiated."
                    },
                    {
                        headerName: "TechBD Zip File Interaction ID",
                        field: "hub_interaction_id",
                        filter: "agTextColumnFilter",
                        headerTooltip: "The unique zip file Interaction ID for the TechBD tenant associated with the CSV file."
                        // cellRenderer: AGGridAide.modalCellRenderer((params, modalAide) => {
                        //     modalAide.viewFetchedJsonValue(window.shell.serverSideUrl(`/api/ux/tabular/jooq/${schemaName}/${viewdetail}/interaction_id/${params.value}.json`));
                        // }, modalAide)
                    },
                    { headerName: "TechBD Tenant ID", field: "tenant_id", headerTooltip: "ID of the tenant involved in the interaction", filter: "agTextColumnFilter" },
                    { headerName: "URI", field: "uri", headerTooltip: "The URI associated with the interaction", filter: "agTextColumnFilter" },
                    { headerName: "Processing Status", field: "status", headerTooltip: "The ZIP file processing status.", filter: "agTextColumnFilter" },
                    {
                        headerName: "CSV Issues", field: "is_failed", headerTooltip: "Issue on generating FHIR from CSV", filter: "agTextColumnFilter", cellRenderer: params => {
                            if (params.value === 'True') {
                                return `<a href="/data-quality/csv-validations/file-not-processed" target="_blank" class="text-blue-600 underline hover:text-blue-800 font-medium">${params.value}</a>`;
                            } else {
                                return params.value
                            }
                        }
                    },
                    // { headerName: "File Count", field: "file_count", headerTooltip: "The total number of files processed, including demographic, administrative, observation, and profile files.", filter: "agNumberColumnFilter" },
                    //{ headerName: "Total Group Count", field: "gourp_count", headerTooltip: "The file group count.", filter: "agNumberColumnFilter" },
                    //{ headerName: "FHIR Group Count", field: "grouping_files", headerTooltip: "The file group count.", filter: "agNumberColumnFilter" },
                    { headerName: "FHIR Count", field: "fhir_count", headerTooltip: "The total number of FHIR interactions associated with this HTTP request.", filter: "agNumberColumnFilter", cellRenderer: 'agGroupCellRenderer' },
                    { headerName: "FHIR Success Count", field: "fhir_count_success", headerTooltip: "The number of successful FHIR interactions where an HTTP response was forwarded.", filter: "agNumberColumnFilter" },
                    {
                        headerName: "Zip File", field: "download", cellClass: "flex justify-center items-center", cellRenderer: downloadCellRenderer,
                        headerTooltip: "Download Zip File", filter: false, suppressFilter: true
                    },
                    {
                        headerName: "OperationOutcome",
                        field: "validation_result_file_name",
                        cellClass: "flex justify-center items-center",
                        cellRenderer: downloadValidationResultCellRenderer,
                        headerTooltip: "Download OperationOutcome",
                        filter: false,
                        suppressFilter: true
                    }
                ])
                .withServerSideDatasource(
                    window.shell.serverSideUrl(`/api/ux/tabular/jooq/${schemaName}/${viewName}.json`),
                    (data, valueCols) => {
                        return valueCols.map(col => ({
                            headerName: col.displayName,
                            field: col.field
                        }));
                    },
                )
                .withMasterDetail(true)
                .withDetailCellRendererParams({
                    detailGridOptions: {
                        columnDefs: fhirColumnDefs,
                        defaultColDef: {
                            flex: 1
                        }
                    },
                    getDetailRowData: params => {
                        getFhirGridData(params);
                    }
                })
                .withDetailRowAutoHeight(false)
                .withModalAide(modalAide)
                .withGridDivStyles({ height: "750px", width: "100%" })
                .build();

            agGridInstance.init('serverDataGrid');
        });
    </script>
</head>

<body>
    <div layout:fragment="content">
        <div class="grid-description">
            <div class=" text-base leading-relaxed">

                <p class="mb-1">
                    This widget presents a detailed view of CSV-based HTTP interactions processed through the system.
                    Each row represents a single interaction initiated via a ZIP file, with essential metadata and
                    outcomes displayed in an accessible format. 
                </p>

                <button id="accordionToggle"
                    class="mb-2 text-blue-700 font-semibold hover:underline focus:outline-none">
                    ▶ Click here to view the column descriptions:
                </button>
                 <div id="accordionContent" class="hidden pl-4 border-l-2 border-blue-200"> 
                <!--<div id="accordionContent"  > -->
                    <p class="mb-2" >
                        <strong>Request Time:</strong> Shows when the interaction was initiated.<br>
                        <strong>TechBD Zip File Interaction ID:</strong> Serves as the unique reference for the
                        submitted ZIP file. Users can use this ID to trace issues and cross-reference CSV validation
                        results.<br>
                        <strong>TechBD Tenant ID:</strong> Identifies the tenant associated with the request.<br>
                        <strong>URI:</strong> Displays the endpoint involved in the interaction.<br>
                        <strong>Processing Status:</strong> Indicates the current state of ZIP file processing (e.g.,
                        <em>Processing Inprogress</em>, <em>Processing Completed</em>, <em>Processing Failed</em>  <!-- <em>Received</em>--> etc.), helping
                        users understand where the file stands in the processing pipeline.<br>
                        <strong>CSV Issues:</strong> Highlights whether the FHIR conversion from the submitted CSV
                        failed. If a failure occurred, a direct link is provided to the
                        <a href="/data-quality/csv-validations/file-not-processed" class="text-blue-600 underline"
                            target="_blank">CSV Data Quality page</a> for detailed error insights. You can use the
                        Interaction ID to filter errors on that page.<br>
                        <!-- <strong>File Count:</strong> Shows the number of files processed within the ZIP (demographic,
                        administrative, observation, and profile files).<br> -->
                        <strong>FHIR Count:</strong> Reflects the total FHIR interactions triggered by the request, and
                        can be expanded for detailed interaction-level insight.<br>
                        <strong>FHIR Success Count:</strong> Indicates how many of those interactions were successfully
                        forwarded as valid FHIR resources to DataLake.<br>
                        <strong>Download Options:</strong> Users can download the original ZIP file submitted for
                        processing and the corresponding OperationOutcome file, which contains validation results for
                        debugging and analysis.
                    </p>
                </div>

                <p>
                    Sorting and filtering options are available throughout the grid to help users efficiently explore,
                    analyze, and identify issues in the interactions.
                </p>

            </div>

            <script>
                const toggleButton = document.getElementById('accordionToggle');
                const content = document.getElementById('accordionContent');

                toggleButton.addEventListener('click', () => {
                    content.classList.toggle('hidden');
                    toggleButton.textContent = content.classList.contains('hidden')
                        ? '▶ Click here to view the column descriptions:'
                        : '▼ Hide column descriptions:';
                });
            </script>


        </div>
        <div id="serverDataGrid" class="ag-theme-alpine"></div>
    </div>
</body>

</html>