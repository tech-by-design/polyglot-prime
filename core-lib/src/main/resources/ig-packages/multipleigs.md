# Implementing Multiple IG Versions with HAPI FHIR Validator

## Overview

This document outlines the approach to implement support for multiple Implementation Guide (IG) versions in a HAPI FHIR Validator. The objective is to preload all supporting IGs once and choose the correct version dynamically based on the profile URL in the FHIR resource (Bundle) during validation.

## Approach

### 1. Specify IG Versions in `application.yml`

The versions of the IG packages to be loaded, along with the necessary profile URL, should be specified in the [application.yml](https://github.com/tech-by-design/polyglot-prime/blob/8efe2441d7958c2e82b689f5d7980605a6b8b3e3/hub-prime/src/main/resources/application.yml#L89-L108)configuration file. Here’s an example configuration:

```yaml
 ig-packages:
  fhir-v4:
    shinny-packages:
    # Any new version of shinny should follow the naming convention: shinny-v<version> in kebab-case
    # Example: shinny-v1-2-3 for version 1.2.3
    # Any new version for test-shinny should follow the naming convention: test-shinny-v<version> in kebab-case
    # Example: test-shinny-v1-3-0 for version 1.3.0
      shinny-v1-2-3:
        profile-base-url: http://shinny.org/us/ny/hrsn
        package-path: ig-packages/shin-ny-ig/shinny/v1.3.0
        ig-version: 1.3.0
      test-shinny-v1-3-0:
        profile-base-url: http://test.shinny.org/us/ny/hrsn
        package-path: ig-packages/shin-ny-ig/test-shinny/v1.3.0
        ig-version: 1.3.0
    base-packages:
    # Base packages for external dependencies 
      us-core: ig-packages/fhir-v4/us-core/stu-7.0.0
      sdoh: ig-packages/fhir-v4/sdoh-clinicalcare/stu-2.2.0
      uv-sdc: ig-packages/fhir-v4/uv-sdc/stu-3.0.0
```
### 2. Preload All Supporting IGs

Preload all the required IGs, including common packages such as `usCore` and `sdoh`, and store them in memory to avoid redundant loading on every request. These packages will be loaded once when the application starts up.

The following IGs can be preloaded:

- [testshinNy]( https://test.shinny.org/downloads.html)
- [shinNy](https://shinny.org/us/ny/hrsn/downloads.html)
- [usCore](https://hl7.org/fhir/us/core/STU7/downloads)
- [sdoh](https://hl7.org/fhir/us/sdoh-clinicalcare/downloads.html.html)
- [uvSdc](https://hl7.org/fhir/uv/sdc/downloads.html)
  
### 3. Extract Profile URL from Bundle
Extract the profile URL from the FHIR resource (Bundle) received through endpoints `/Bundle` ,`/Bundle/$validate`and check it against the profile-base-url specified in the configuration. Based on the matching URL, the appropriate IG package will be used for validation.If no match is found,,the baseFHIRUrl configured in the `application.yml` will be used.

### 4. Base FHIR URL in TechByDesign Generated FHIR Resources
In the case where FHIR resources are generated by a TechByDesign , we will add an optional header `X-TechBD-Base-FHIR-URL` for endpoints `/flatfile/csv/Bundle` and `/ccda/Bundle`. If this is specified this will be used as the base profile URL for all the FHIR resources generated from the CSV /CCD respectively, ensuring that they can be matched correctly to the respective IGs during validation.If not provided ,the baseFHIRUrl configured in the `application.yml` will be used.

matching to the respective Implementation Guides (IGs) during validation. If not provided, the baseFHIRUrl configured in the application.yml will be used.


#### Default `baseFHIRUrl` Values in Different Environments:
- **Development (devl)**: [View in application.yml](https://github.com/tech-by-design/polyglot-prime/blob/8efe2441d7958c2e82b689f5d7980605a6b8b3e3/hub-prime/src/main/resources/application.yml#L109)
- **Staging (stage)**: [View in application.yml](https://github.com/tech-by-design/polyglot-prime/blob/8efe2441d7958c2e82b689f5d7980605a6b8b3e3/hub-prime/src/main/resources/application.yml#L109)
- **PHI QA (phiqa)**: [View in application-phiqa.yml](https://github.com/tech-by-design/polyglot-prime/blob/8efe2441d7958c2e82b689f5d7980605a6b8b3e3/hub-prime/src/main/resources/application-phiqa.yml#L44)
- **PHI Production (phiprod)**: [View in application-phiprod.yml](https://github.com/tech-by-design/polyglot-prime/blob/8efe2441d7958c2e82b689f5d7980605a6b8b3e3/hub-prime/src/main/resources/application-phiprod.yml#L44)




### 5. MirthConnect Integration

In Nexus integration, multiple IG versions and changes will also be integrated into MirthConnect. This will allow for seamless integration and validation of FHIR resources within MirthConnect’s workflows. The goal is to ensure that MirthConnect can handle different IG versions dynamically and apply the correct profile validation during the message processing.

The integration will include:
- Preloading and dynamically selecting the correct IG version in MirthConnect.
- Ensuring that MirthConnect can handle different profiles and validate them against the appropriate IGs based on the profile URL.
- Updating MirthConnect’s configuration to support the required changes for multiple IG versions.


### 6. Adding a New Package for SHIN-NY

To add a new package for SHIN-NY IG, follow these steps:

#### If a SHIN-NY IG version is updated:

1. **Download the package** and copy it to the respective folder:

   - **SHINNY Package:** [Download](https://shinny.org/us/ny/hrsn/package.tgz)

2. **Create a new folder** with the name `v<version>`. For example, for SHIN-NY IG version `1.3.0`, create a folder named `v1.3.0` under the following location:

   - [SHIN-NY IG Path](https://github.com/tech-by-design/polyglot-prime/tree/main/hub-prime/src/main/resources/ig-packages/shin-ny-ig/shinny)
   - **Copy the downloaded package to this folder.**

3. **Update `application.yml`** at this path:

   - [Application Configuration](https://github.com/tech-by-design/polyglot-prime/blob/8efe2441d7958c2e82b689f5d7980605a6b8b3e3/hub-prime/src/main/resources/application.yml#L96)
   - Add the following configuration:
     ```yaml
     shinny-v1-3-0:
      profile-base-url: http://shinny.org/us/ny/hrsn
      package-path: ig-packages/shin-ny-ig/shinny/v1.2.3
      ig-version: 1.2.3
     ```

---

#### If a test SHIN-NY IG version is updated:

1. **Download the package and copy it to the respective folder:**

   - **Test SHIN-NY Package:** [Download](https://test.shinny.org/package.tgz)

2. **Create another new folder** for the test SHIN-NY IG version `1.3.0` under:

   - [Test SHIN-NY IG Path](https://github.com/tech-by-design/polyglot-prime/tree/main/hub-prime/src/main/resources/ig-packages/shin-ny-ig/test-shinny)
   - **Copy the downloaded package to this folder.**

3. **Update `application.yml`** at this path:

   - [Application Configuration](https://github.com/tech-by-design/polyglot-prime/blob/8efe2441d7958c2e82b689f5d7980605a6b8b3e3/hub-prime/src/main/resources/application.yml#L100)
   - Add the following configuration:
     ```yaml
         test-shinny-v1-3-0:
            profile-base-url: http://test.shinny.org/us/ny/hrsn
            package-path: ig-packages/shin-ny-ig/test-shinny/v1.3.0
            ig-version: 1.3.0
     ```
### 7. Potential Problems
Additional Packages Loaded to Memory: The solution of preloading all IGs can cause unnecessary memory usage if you load a large number of IG packages. 